<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/plugin/layui/css/layui.css">
<script src="/plugin/layui/layui.all.js"></script>
<script src="/plugin/jquery/jquery.js"></script>
<script src="/plugin/jquery/jquery.serializejson.js"></script>
<script src="/plugin/jsrender/jsrender.js"></script>
<script src="/plugin/echarts/echarts.js"></script>
</head>
<body>
  <div class="layui-container" style="width:100%; height:100%">
    <div class="layui-col-md8">
      <button class="layui-btn" type="button" id="convert" onclick="goConvert()">Itemization</button>
      <div id="riskChart" style="width:100%; height:500px"></div>
    </div>
    <div class="layui-col-md4">
      <div id="informationText"></div>
    </div>
  </div>
  <script id="information" type="text/x-jsrender">
    <p>Total Risk Value: {{:totalRisk}}</p>
    <br />
    <p>Risk Factors:</p>
    {{props riskData}}
      {{if prop > 0}}
        <p>{{:key}}</p>
      {{/if}}
    {{/props}}
    <br />
    <p>Recommonded Tests:</p>
    {{for recommondedTestList}}
      <p>{{:name}}</p>
    {{/for}}
  </script>
  <script>
    var status = 'person';
    var riskChart = echarts.init(document.getElementById('riskChart'));
    var resultId = localStorage.getItem('currentResultId');
    $(document).ready(function() {
      goChart(resultId);
    });
  
    function goChart(resultId) {
      $.ajax({
        async : false,
        type : 'GET',
        url : '/result/assess/' + resultId,
        contentType : 'application/json',
        success : function(result) {
          $('#informationText').html($.templates('#information').render(result));
          if(status === 'person') {
            displayByPerson(result.riskData, result.avgRiskData);
          } else if(status === 'risk') {
            displayByRisk(result.riskData, result.avgRiskData);
          }
        }
      });
    }
    
    function displayByPerson(riskData, avgRiskData) {
      var legendData = [];
      var series = [];
      for (var risk in riskData) {
        legendData.push(risk);
        var serie = {
          name: risk,
          type: 'bar',
          barWidth: 20,
          stack: 'TotalRisk',
          label: {
            normal: {
              show: true,
              position: 'insideRight'
            }
          },
          data: [riskData[risk], avgRiskData[risk]]
        };
        series.push(serie);
      }
      var option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        legend: {
          data: legendData
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'value'
        },
        yAxis:  {
          type: 'category',
          data: ['You', 'Avg']
        },
        series: series
      };
      riskChart.setOption(option, true);
      window.onresize = riskChart.resize;
    }

    function displayByRisk(riskData, avgRiskData) {
      var yAxisData = [];
      var seriesData = [];
      var avgSeriesData = [];
      for (var risk in riskData) {
        yAxisData.push(risk);
        seriesData.push(riskData[risk]);
        avgSeriesData.push(avgRiskData[risk]);
      }
      var option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        legend: {
          data: ['You', 'Avg']
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'value'
        },
        yAxis:  {
          type: 'category',
          data: yAxisData
        },
        series: [{
          name: 'You',
          type: 'bar',
          label: {
            normal: {
              show: true,
              position: 'insideRight'
            }
          },
          data: seriesData
        },
        {
          name: 'Avg',
          type: 'bar',
          label: {
            normal: {
              show: true,
              position: 'insideRight'
            }
          },
          data: avgSeriesData        
        }]
      };
      riskChart.setOption(option, true);
      window.onresize = riskChart.resize;
    }
		
    function goConvert() {
      if(status === 'person') {
        $('#convert').text('Accumulation');
        status = 'risk';
      } else if(status === 'risk') {
        $('#convert').text('Itemization');
        status = 'person';
      }
      goChart(resultId);
    }
  </script>
</body>
</html>
